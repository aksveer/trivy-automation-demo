name: Trivy Scan & Auto PR (Debug)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Debug ‚Äì Show repo structure
        run: |
          echo "üìÇ Repository root:"
          ls -la
          echo "üìÇ .github folder:"
          ls -la .github || true

      - name: Install Trivy
        run: |
          set -x
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin
          trivy --version

      - name: Debug ‚Äì Verify Trivy binary
        run: |
          which trivy
          trivy --help | head -n 20

      - name: Run Trivy scan (JSON)
        run: |
          set -x
          trivy fs . \
            --scanners vuln \
            --severity LOW,MEDIUM,HIGH,CRITICAL \
            --format json \
            --output trivy-full-report.json \
            --exit-code 0

      - name: Debug ‚Äì Verify Trivy output file
        run: |
          echo "üìÑ Files after scan:"
          ls -la
          echo "üìè Size of trivy-full-report.json:"
          stat trivy-full-report.json
          echo "üßæ First 40 lines of report:"
          head -n 40 trivy-full-report.json

      - name: Debug ‚Äì Validate JSON structure
        run: |
          echo "üîç Checking JSON validity"
          jq '.' trivy-full-report.json > /dev/null
          echo "‚úÖ JSON is valid"
          echo "üîç Top-level keys:"
          jq 'keys' trivy-full-report.json

      - name: Extract vulnerabilities only
        run: |
          set -x
          jq '{
            generatedAt: now | todate,
            vulnerabilities: [
              .Results[]
              | select(.Vulnerabilities != null)
              | .Vulnerabilities[]
            ]
          }' trivy-full-report.json > trivy-vulnerabilities.json

      - name: Debug ‚Äì Inspect extracted vulnerabilities
        run: |
          echo "üìè Extracted file size:"
          stat trivy-vulnerabilities.json
          echo "üßæ Sample vulnerabilities (first 20 lines):"
          head -n 20 trivy-vulnerabilities.json
          echo "üî¢ Total vulnerabilities:"
          jq '.vulnerabilities | length' trivy-vulnerabilities.json

      - name: Count vulnerabilities by severity
        run: |
          echo "CRITICAL_COUNT=$(jq '[.vulnerabilities[] | select(.Severity=="CRITICAL")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV
          echo "HIGH_COUNT=$(jq '[.vulnerabilities[] | select(.Severity=="HIGH")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV
          echo "MEDIUM_COUNT=$(jq '[.vulnerabilities[] | select(.Severity=="MEDIUM")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV
          echo "LOW_COUNT=$(jq '[.vulnerabilities[] | select(.Severity=="LOW")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV

      - name: Debug ‚Äì Severity summary
        run: |
          echo "üö® CRITICAL: $CRITICAL_COUNT"
          echo "üî• HIGH: $HIGH_COUNT"
          echo "‚ö†Ô∏è MEDIUM: $MEDIUM_COUNT"
          echo "‚ÑπÔ∏è LOW: $LOW_COUNT"

      - name: Debug ‚Äì API trigger condition
        run: |
          if [ "$CRITICAL_COUNT" != "0" ] || [ "$HIGH_COUNT" != "0" ]; then
            echo "‚úÖ Auto PR API WILL be triggered"
          else
            echo "‚õî Auto PR API will NOT be triggered"
          fi
