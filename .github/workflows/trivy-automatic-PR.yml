name: Trivy Scan & Auto PR (Debug)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  trivy-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      GITHUB_TOKEN: ${{ secrets.TOKEN_PR }}
      GITHUB_REPOSITORY_NAME: trivy-automation-demo
      GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Debug â€“ Show repo structure
        run: |
          echo "ðŸ“‚ Repository root:"
          ls -la
          echo "ðŸ“‚ .github folder:"
          ls -la .github || true

      - name: Install Trivy
        run: |
          set -x
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sudo sh -s -- -b /usr/local/bin
          trivy --version

      - name: Debug â€“ Verify Trivy binary
        run: |
          which trivy
          trivy --help | head -n 20

      - name: Run Trivy scan (JSON)
        run: |
          set -x
          trivy fs . \
            --scanners vuln \
            --severity LOW,MEDIUM,HIGH,CRITICAL \
            --format json \
            --output trivy-full-report.json \
            --exit-code 0

      - name: Debug â€“ Verify Trivy output file
        run: |
          echo "ðŸ“„ Files after scan:"
          ls -la
          echo "ðŸ“ Size of trivy-full-report.json:"
          stat trivy-full-report.json
          echo "ðŸ§¾ First 40 lines of report:"
          head -n 40 trivy-full-report.json

      - name: Debug â€“ Validate JSON structure
        run: |
          echo "ðŸ” Checking JSON validity"
          jq '.' trivy-full-report.json > /dev/null
          echo "âœ… JSON is valid"
          echo "ðŸ” Top-level keys:"
          jq 'keys' trivy-full-report.json

      - name: Extract vulnerabilities only
        run: |
          set -x
          jq '{
            Results: [
              .Results[]
            | select(.Vulnerabilities != null and (.Vulnerabilities | length > 0))
            | {
                Vulnerabilities: .Vulnerabilities
              }
          ]
          }' trivy-full-report.json > trivy-vulnerabilities.json

      - name: Debug â€“ Inspect extracted vulnerabilities
        run: |
          echo "ðŸ“ Extracted file size:"
          stat trivy-vulnerabilities.json
          echo "ðŸ§¾ Sample vulnerabilities (first 20 lines):"
          head -n 20 trivy-vulnerabilities.json
          echo "ðŸ”¢ Total vulnerabilities:"
          jq '.Results[].Vulnerabilities | length' trivy-vulnerabilities.json

      - name: Count vulnerabilities by severity
        id: vuln_count
        run: |
          echo "CRITICAL_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV
          echo "HIGH_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="HIGH")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV
          echo "MEDIUM_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="MEDIUM")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV
          echo "LOW_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity=="LOW")] | length' trivy-vulnerabilities.json)" >> $GITHUB_ENV
          
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "should_trigger=true" >> $GITHUB_OUTPUT
          else
            echo "should_trigger=false" >> $GITHUB_OUTPUT
          fi

      - name: Debug â€“ Severity summary
        run: |
          echo "ðŸš¨ CRITICAL: $CRITICAL_COUNT"
          echo "ðŸ”¥ HIGH: $HIGH_COUNT"
          echo "âš ï¸ MEDIUM: $MEDIUM_COUNT"
          echo "â„¹ï¸ LOW: $LOW_COUNT"

      - name: Debug â€“ API trigger condition
        run: |
          if [ "$CRITICAL_COUNT" != "0" ] || [ "$HIGH_COUNT" != "0" ]; then
            echo "âœ… Auto PR API WILL be triggered"
          else
            echo "â›” Auto PR API will NOT be triggered"
          fi

      - name: Check file path
        run: |
          echo "File path: $(pwd)"
          echo "File path: $(ls -la)"

      - name: Build Spring Boot service
        if: steps.vuln_count.outputs.should_trigger == 'true'
        run: |
          ./mvnw clean package -DskipTests

      - name: Start Auto PR Service
        if: steps.vuln_count.outputs.should_trigger == 'true'
        run: |
          nohup java -jar target/*.jar > service.log 2>&1 &
          echo "Waiting for service to start..."
          sleep 15

      - name: Debug â€“ Verify service is running
        if: steps.vuln_count.outputs.should_trigger == 'true'
        run: |
          curl -s http://localhost:8080/actuator/health || true
          echo "---- Service Logs ----"
          tail -n 50 service.log

      - name: Call local Auto PR Service
        if: steps.vuln_count.outputs.should_trigger == 'true'
        run: |
          curl -X POST http://localhost:8080/api/v1/trivy/fix \
            -F "file=@trivy-vulnerabilities.json"